---
title: "Notebook 19"
output:
  html_document:
    theme: cosmo
    highlight: zenburn
    css: "note-style.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggrepel)
library(stringi)
library(sf)

source("cache.R")

theme_set(theme_minimal())
options(pillar.min_character_chars = 15)
options(readr.show_col_types = FALSE)
options(width = 77L)
options(dplyr.summarise.inform = FALSE)
options(ggrepel.max.overlaps = Inf)
Sys.setlocale(locale = "en_US.UTF-8")
sm_centroid <- function(data) {
  suppressWarnings({ z <- st_coordinates(st_centroid(data)) })
  return(tibble(lon = z[,1], lat = z[,2]))
}

theme_set(theme_minimal())
```

### Introduction

This notebook introduces methods for working with spatial data in R. We will see
methods for creating spatial data from a data set with longitude and latitude,
how to plot spatial data, how to project spatial data, and how to compute
spatial summaries from lines and polygons.

### Spatial Points


```{r}
us <- read_csv("data/us_city_population.csv") %>%
  filter(year == 2010) %>% 
  filter(!is.na(lon), !is.na(lat))
```

```{r}
us %>% 
  ggplot(aes(lon, lat)) +
    geom_point()
```

```{r}
us_geo <- us %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)
```

```{r}
us_geo
```


```{r}
us_geo %>% 
  ggplot() +
    geom_sf()
```


```{r}
us_geo %>% 
  ggplot() +
    geom_sf(color = "pink", size = 5, alpha = 0.3)
```


```{r}
us_geo %>% 
  st_transform(5069) %>%
  ggplot() +
    geom_sf()
```

```{r, fig.height=8}
us_geo %>% 
  st_transform(5069) %>%
  ggplot() +
    geom_sf_text(aes(label = city), size = 10)
```

### Spatial Lines

```{r}
nyc <- read_sf("data/ny_roads.geojson")
nyc
```

```{r, fig.height=8}
nyc %>%
  ggplot() +
    geom_sf()
```

```{r, fig.height=8}
nyc %>%
  ggplot() +
    geom_sf(color = "pink")
```

```{r, fig.height=8}
nyc %>%
  mutate(len = as.numeric(st_length(geometry))) %>%
  arrange(desc(len))
```

```{r, fig.height=8}
nyc_road <- nyc %>%
  filter(name == "Broadway")

nyc %>%
  ggplot() +
    geom_sf(alpha = 0.3) +
    geom_sf(data = nyc_road, color = "orange", size = 2)
```

### Spatial Polygons

```{r}
state <- read_sf("data/state.geojson")
state
```

```{r}
state %>%
  ggplot() +
    geom_sf()
```

```{r}
state %>%
  st_transform(5069) %>%
  ggplot() +
    geom_sf()
```


```{r}
state %>%
  filter(!(abb %in% c("AK", "HI"))) %>%
  st_transform(5069) %>%
  ggplot() +
    geom_sf()
```

```{r}
state %>%
  filter(!(abb %in% c("AK", "HI"))) %>%
  mutate(area = as.numeric(st_area(geometry)) / 1e6)
```


```{r}
state %>%
  filter(!(abb %in% c("AK", "HI"))) %>%
  mutate(area = as.numeric(st_area(geometry)) / 1e6) %>%
  st_transform(5069) %>%
  ggplot() +
    geom_sf(aes(fill = area))
```

```{r}
state %>%
  filter(!(abb %in% c("AK", "HI"))) %>%
  mutate(area = as.numeric(st_area(geometry)) / 1e6) %>%
  st_transform(5069) %>%
  ggplot() +
    geom_sf(aes(fill = area)) +
    scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 10
    )
```

```{r}
state %>%
  mutate(sm_centroid(geometry))
```

### Application: French COVID-19 Data

```{r}
covid <- read_csv("data/france_departement_covid.csv")
pop <- read_csv("data/france_departement_population.csv")
cities <- read_csv("data/france_cities.csv")
geo_fr <- read_sf("data/france_departement.geojson") %>%
  filter(departement <= "95")
```

```{r, fig.height=7}
geo_fr %>%
  ggplot() +
    geom_sf()
```


```{r}
covid %>%
  filter(date == "2020-05-01") %>%
  left_join(geo_fr, by = "departement")
```

```{r, fig.height=7}
covid %>%
  filter(date == "2020-05-01") %>%
  left_join(geo_fr, by = "departement") %>%
  st_as_sf() %>%
  ggplot() +
    geom_sf(aes(fill = hospitalised)) +
    scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 10
    )
```

```{r, fig.height=7}
covid %>%
  filter(date == "2020-05-01") %>%
  left_join(geo_fr, by = "departement") %>%
  left_join(pop, by = "departement") %>%
  mutate(rate = hospitalised / population * 100000) %>%
  st_as_sf() %>%
  ggplot() +
    geom_sf(aes(fill = rate)) +
    scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 10
    )
```

```{r}
cities_geo <- cities %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)
```

```{r, fig.height=7, warning = FALSE}
covid %>%
  filter(date == "2020-05-01") %>%
  left_join(geo_fr, by = "departement") %>%
  left_join(pop, by = "departement") %>%
  mutate(rate = hospitalised / population * 100000) %>%
  st_as_sf() %>%
  ggplot() +
    geom_sf(aes(fill = rate), alpha = 0.8) +
    geom_sf(data = cities_geo) +
    geom_sf_text(aes(label = city), data = cities_geo, nudge_y = 0.1, size = 6) +
    scale_fill_distiller(
      trans = "log2", palette = "Spectral", guide = "legend", n.breaks = 10
    )
```

