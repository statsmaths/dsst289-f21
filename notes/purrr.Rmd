---
title: "purrr"
output:
  html_document:
    theme: cosmo
    highlight: zenburn
    css: "note-style.css"
---

```{r, include=FALSE, message=FALSE}
library(tidyverse)
library(stringi)
library(ggrepel)
library(smodels)

library(jsonlite)
library(lubridate)

theme_set(theme_minimal())
options(pillar.min_character_chars = 15)
options(dplyr.summarise.inform = FALSE)
options(readr.show_col_types = FALSE)
options(ggrepel.max.overlaps = Inf)
options(width = 85L)

food <- read_csv(file.path("data", "food.csv"))
food_prices <- read_csv(file.path("data", "food_prices.csv"))

Sys.setenv("VROOM_CONNECTION_SIZE" = 131072 * 10000)
```

```{r}
base_url <- "https://en.wikipedia.org/w/api.php"
options <- "?action=query&format=json&prop=pageviews&titles="
url <- stri_paste(base_url, options, "apple")

json_text <- read_lines(url)
obj <- parse_json(json_text)
```

```{r}
obj$query$pages$`18978754`$pageid
obj$query$pages$`18978754`$ns
obj$query$pages$`18978754`$title
```


```{r}
pv <- obj$query$pages$`18978754`$pageviews

df <- tibble(
  pageid = obj$query$pages$`18978754`$pageid,
  ns = obj$query$pages$`18978754`$ns,
  title = obj$query$pages$`18978754`$title,
  date = names(pv),
  pageviews = map_int(pv, function(v) v)
)

df <- df %>%
  mutate(date = ymd(date))

df %>%
  ggplot(aes(date, pageviews)) +
    geom_line()
```

## Weather



```{r}
lat <- 39.7456
lon <- -97.0892

points_url <- sprintf("https://api.weather.gov/points/%f,%f", lat, lon)
points_obj <- parse_json(read_lines(points_url))
grid_x <- points_obj$properties$gridX
grid_y <- points_obj$properties$gridY
```


```{r}
base_url <- "https://api.weather.gov/gridpoints/TOP/%d,%d/forecast?units=si"
forecast_url <- sprintf(base_url, grid_x, grid_y)
forecast_obj <- parse_json(read_lines(forecast_url))
```

```{r}
periods <- forecast_obj$properties$periods
length(periods)
```

```{r}
periods[[1]]
```


```{r}
df <- tibble(
  name = periods[[1]]$name,
  start_time = ymd_hms(periods[[1]]$startTime),
  end_time = ymd_hms(periods[[1]]$endTime),
  temperature = periods[[1]]$temperature,
  wind_speed = periods[[1]]$windSpeed,
  wide_direction = periods[[1]]$windDirection,
  short_forecase = periods[[1]]$shortForecast  
)
df
```
```{r}
forecast <- map_df(periods, function(v) {
  df <- tibble(
    name = v$name,
    start_time = ymd_hms(v$startTime),
    end_time = ymd_hms(v$endTime),
    temperature = v$temperature,
    wind_speed = v$windSpeed,
    wind_direction = v$windDirection,
    short_forecase = v$shortForecast  
  )
  return(df)
})
forecast
```

### Hourly

```{r}
base_url <- "https://api.weather.gov/gridpoints/TOP/%d,%d/forecast/hourly?units=si"
forecast_url <- sprintf(base_url, grid_x, grid_y)
forecast_obj <- parse_json(read_lines(forecast_url))
```

```{r}
periods <- forecast_obj$properties$periods
length(periods)
```

```{r}
forecast <- map_df(periods, function(v) {
  df <- tibble(
    start_time = ymd_hms(v$startTime),
    end_time = ymd_hms(v$endTime),
    temperature = v$temperature,
    wind_speed = v$windSpeed,
    wind_direction = v$windDirection,
    short_forecase = v$shortForecast  
  )
  return(df)
})
forecast
```

```{r}
forecast %>%
  ggplot(aes(start_time, temperature)) +
    geom_line(aes(color = factor(day(start_time))), size = 2, show.legend = FALSE)
```

## Crypto

```{r}
crypto_url <- "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=30"
crypto_obj <- parse_json(read_lines(crypto_url))
```

```{r}
names(crypto_obj)
```


```{r}
crypto_obj$prices[[1]]
```


```{r}
time_ms <- map_dbl(crypto_obj$prices, function(v) {
  v[[1]]
})
price <- map_dbl(crypto_obj$prices, function(v) {
  v[[2]]
})
market_cap <- map_dbl(crypto_obj$market_caps, function(v) {
  v[[2]]
})
volume <- map_dbl(crypto_obj$total_volumes, function(v) {
  v[[2]]
})


df <- tibble(
  time = as_datetime(time_ms / 1000),
  price = price,
  #market_cap = market_cap,
  volume
)
df
```

```{r}
df %>%
  ggplot(aes(time, price)) +
    geom_line()
```

## Hacker News

```{r}
hn_top_url <- "https://hacker-news.firebaseio.com/v0/topstories.json"
hn_top_obj <- parse_json(read_lines(hn_top_url))
hn_top_obj <- as.integer(hn_top_obj)
```

```{r}
hn_id_url <- "https://hacker-news.firebaseio.com/v0/item/%d.json"
id <- hn_top_obj[1]

hn_obj <- parse_json(read_lines(sprintf(hn_id_url, id)))
hn_obj
```

```{r}
kid_ids <- as.integer(hn_obj$kids)
```

```{r}
hn_kid_obj <- parse_json(read_lines(sprintf(hn_id_url, kid_ids[1])))
hn_kid_obj
```

```{r}
hn_user_url <- "https://hacker-news.firebaseio.com/v0/user/%s.json"

user <- hn_obj$by
hn_obj <- parse_json(read_lines(sprintf(hn_user_url, user)))
names(hn_obj)
```

```{r}
hn_obj$about
```


```{r}
df_hn <- map_df(head(hn_top_obj), function(v) {
  obj <- parse_json(read_lines(sprintf(hn_id_url, v)))

  df <- tibble(
    by = obj$by,
    type = obj$type,
    title = obj$title,
    score = obj$score,
    time = obj$time,
    kids = length(obj$kids),
    descendants = obj$descendants,
    url = obj$url
  )
  return(df)
})
df_hn
```

## XKCD

```{r}
xkcd_url <- "https://xkcd.com/%d/info.0.json"
xkcd_obj <- parse_json(read_lines(sprintf(xkcd_url, 301)))
xkcd_obj
```

```{r}
cat(xkcd_obj$transcript)
```

## Census

```{r}
"https://geocoding.geo.census.gov/geocoder/locations/onelineaddress?address=8+N+Rowland,Richmond,VA&benchmark=2020&format=json"
```




